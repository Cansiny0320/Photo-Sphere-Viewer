{"version":3,"file":"compass.js","sources":["../../src/plugins/compass/index.js"],"sourcesContent":["import * as THREE from 'three';\nimport { AbstractPlugin, CONSTANTS, SYSTEM, utils } from '../..';\nimport compass from './compass.svg';\nimport './style.scss';\n\n\n/**\n * @typedef {Object} PSV.plugins.CompassPlugin.Options\n * @property {string} [size='120px'] - size of the compass\n * @property {string} [position='top left'] - position of the compass\n * @property {string} [backgroundSvg] - SVG used as background of the compass\n * @property {string} [coneColor='rgba(255, 255, 255, 0.5)'] - color of the cone of the compass\n * @property {boolean} [navigation=true] - allows to click on the compass to rotate the viewer\n * @property {string} [navigationColor='rgba(255, 0, 0, 0.2)'] - color of the navigation cone\n * @property {PSV.plugins.CompassPlugin.Hotspot[]} [hotspots] - small dots visible on the compass (will contain every marker with the \"compass\" data)\n * @property {string} [hotspotColor='rgba(0, 0, 0, 0.5)'] - default color of hotspots\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.CompassPlugin.Hotspot\n * @type {string} [color] - override the global \"hotspotColor\"\n */\n\n\nconst HOTSPOT_SIZE_RATIO = 1 / 40;\n\n\n/**\n * @summary Adds a compass on the viewer\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class CompassPlugin extends AbstractPlugin {\n\n  static id = 'compass';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.CompassPlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.plugins.CompassPlugin.Options}\n     * @private\n     */\n    this.config = {\n      size           : '120px',\n      position       : 'top left',\n      backgroundSvg  : compass,\n      coneColor      : 'rgba(255, 255, 255, 0.5)',\n      navigation     : true,\n      navigationColor: 'rgba(255, 0, 0, 0.2)',\n      hotspotColor   : 'rgba(0, 0, 0, 0.5)',\n      ...options,\n    };\n    this.config.position = utils.cleanPosition(this.config.position, 'top left');\n\n    /**\n     * @private\n     */\n    this.prop = {\n      mouse    : null,\n      mouseDown: false,\n      markers  : [],\n    };\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = this.psv.getPlugin('markers');\n\n    /**\n     * @member {HTMLElement}\n     * @readonly\n     * @private\n     */\n    this.container = document.createElement('div');\n    utils.addClasses(this.container, `psv-compass psv-compass--${this.config.position.join('-')}`);\n    this.container.innerHTML = this.config.backgroundSvg;\n\n    this.container.style.width = this.config.size;\n    this.container.style.height = this.config.size;\n    if (this.config.position[0] === 'center') {\n      this.container.style.marginTop = `calc(-${this.config.size} / 2)`;\n    }\n    if (this.config.position[1] === 'center') {\n      this.container.style.marginLeft = `calc(-${this.config.size} / 2)`;\n    }\n\n    if (this.config.navigation) {\n      this.container.addEventListener('mouseenter', this);\n      this.container.addEventListener('mouseleave', this);\n      this.container.addEventListener('mousemove', this);\n      this.container.addEventListener('mousedown', this);\n      this.container.addEventListener('mouseup', this);\n    }\n\n    this.psv.container.appendChild(this.container);\n\n    /**\n     * @member {HTMLCanvasElement}\n     * @readonly\n     * @private\n     */\n    this.canvas = document.createElement('canvas');\n    this.canvas.width = this.container.clientWidth * SYSTEM.pixelRatio;\n    this.canvas.height = this.container.clientWidth * SYSTEM.pixelRatio;\n\n    this.container.appendChild(this.canvas);\n\n    this.psv.on(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.on('set-markers', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.off('set-markers', this);\n    }\n\n    this.psv.container.removeChild(this.container);\n\n    delete this.canvas;\n    delete this.container;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    switch (e.type) {\n      case CONSTANTS.EVENTS.RENDER:\n        this.__update();\n        break;\n      case 'set-markers':\n        this.prop.markers = e.args[0].filter(m => m.data?.compass);\n        this.__update();\n        break;\n      case 'mouseenter':\n      case 'mousemove':\n        this.prop.mouse = e;\n        if (this.prop.mouseDown) {\n          this.__click();\n        }\n        else {\n          this.__update();\n        }\n        e.stopPropagation();\n        break;\n      case 'mousedown':\n        this.prop.mouseDown = true;\n        break;\n      case 'mouseup':\n        this.prop.mouse = e;\n        this.prop.mouseDown = false;\n        this.__click();\n        e.stopPropagation();\n        break;\n      case 'mouseleave':\n        this.prop.mouse = null;\n        this.prop.mouseDown = false;\n        this.__update();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * @summary Changes the hotspots on the compass\n   * @param {PSV.plugins.CompassPlugin.Hotspot[]} hotspots\n   */\n  setHotspots(hotspots) {\n    this.config.hotspots = hotspots;\n    this.__update();\n  }\n\n  /**\n   * @summary Updates the compass for current zoom and position\n   * @private\n   */\n  __update() {\n    const context = this.canvas.getContext('2d');\n    context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n\n    const longitude = this.psv.getPosition().longitude;\n    const fov = THREE.Math.degToRad(this.psv.prop.hFov);\n\n    this.__drawCone(context, this.config.coneColor, longitude, fov);\n\n    const mouseAngle = this.__getMouseAngle();\n    if (mouseAngle !== null) {\n      this.__drawCone(context, this.config.navigationColor, mouseAngle, fov);\n    }\n\n    this.prop.markers.forEach((marker) => {\n      this.__drawMarker(context, marker);\n    });\n    this.config.hotspots?.forEach((spot) => {\n      if ('longitude' in spot && !('latitude' in spot)) {\n        spot.latitude = 0;\n      }\n      const pos = this.psv.dataHelper.cleanPosition(spot);\n      this.__drawPoint(context, spot.color || this.config.hotspotColor, pos.longitude, pos.latitude);\n    });\n  }\n\n  /**\n   * @summary Rotates the viewer depending on the position of the mouse on the compass\n   * @private\n   */\n  __click() {\n    const mouseAngle = this.__getMouseAngle();\n\n    if (mouseAngle !== null) {\n      this.psv.rotate({\n        longitude: mouseAngle,\n        latitude : 0,\n      });\n    }\n  }\n\n  /**\n   * @summary Draw a cone\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} fov\n   * @private\n   */\n  __drawCone(context, color, longitude, fov) {\n    const a1 = longitude - Math.PI / 2 - fov / 2;\n    const a2 = a1 + fov;\n    const c = this.canvas.width / 2;\n\n    context.beginPath();\n    context.moveTo(c, c);\n    context.lineTo(c + Math.cos(a1) * c, c + Math.sin(a1) * c);\n    context.arc(c, c, c, a1, a2, false);\n    context.lineTo(c, c);\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Draw a Marker\n   * @param {CanvasRenderingContext2D} context\n   * @param {PSV.plugins.MarkersPlugin.Marker} marker\n   * @private\n   */\n  __drawMarker(context, marker) {\n    let color = this.config.hotspotColor;\n    if (typeof marker.data.compass === 'string') {\n      color = marker.data.compass;\n    }\n\n    if (marker.isPoly()) {\n      context.beginPath();\n      marker.props.def.forEach(([longitude, latitude], i) => {\n        const a = longitude - Math.PI / 2;\n        const d = (latitude + Math.PI / 2) / Math.PI;\n        const c = this.canvas.width / 2;\n\n        context[i === 0 ? 'moveTo' : 'lineTo'](c + Math.cos(a) * c * d, c + Math.sin(a) * c * d);\n      });\n      if (marker.isPolygon()) {\n        context.fillStyle = color;\n        context.fill();\n      }\n      else {\n        context.strokeStyle = color;\n        context.lineWidth = Math.max(1, this.canvas.width * HOTSPOT_SIZE_RATIO / 2);\n        context.stroke();\n      }\n    }\n    else {\n      const pos = marker.props.position;\n      this.__drawPoint(context, color, pos.longitude, pos.latitude);\n    }\n  }\n\n  /**\n   * @summary Draw a point\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} latitude - in viewer reference\n   * @private\n   */\n  __drawPoint(context, color, longitude, latitude) {\n    const a = longitude - Math.PI / 2;\n    const d = (latitude + Math.PI / 2) / Math.PI;\n    const c = this.canvas.width / 2;\n    const r = Math.max(2, this.canvas.width * HOTSPOT_SIZE_RATIO);\n\n    context.beginPath();\n    context.ellipse(\n      c + Math.cos(a) * c * d, c + Math.sin(a) * c * d,\n      r, r,\n      0, 0, Math.PI * 2\n    );\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Gets the longitude corresponding to the mouse position on the compass\n   * @return {number | null}\n   * @private\n   */\n  __getMouseAngle() {\n    if (!this.prop.mouse) {\n      return null;\n    }\n\n    const boundingRect = this.container.getBoundingClientRect();\n    const mouseX = this.prop.mouse.clientX - boundingRect.left - boundingRect.width / 2;\n    const mouseY = this.prop.mouse.clientY - boundingRect.top - boundingRect.width / 2;\n\n    if (Math.sqrt(mouseX * mouseX + mouseY * mouseY) > boundingRect.width / 2) {\n      return null;\n    }\n\n    return Math.atan2(mouseY, mouseX) + Math.PI / 2;\n  }\n\n}\n"],"names":["HOTSPOT_SIZE_RATIO","CompassPlugin","psv","options","config","size","position","backgroundSvg","compass","coneColor","navigation","navigationColor","hotspotColor","utils","cleanPosition","prop","mouse","mouseDown","markers","getPlugin","container","document","createElement","addClasses","join","innerHTML","style","width","height","marginTop","marginLeft","addEventListener","appendChild","canvas","clientWidth","SYSTEM","pixelRatio","on","CONSTANTS","EVENTS","RENDER","destroy","off","removeChild","handleEvent","e","type","__update","args","filter","m","data","__click","stopPropagation","setHotspots","hotspots","context","getContext","clearRect","longitude","getPosition","fov","THREE","Math","degToRad","hFov","__drawCone","mouseAngle","__getMouseAngle","forEach","marker","__drawMarker","spot","latitude","pos","dataHelper","__drawPoint","color","rotate","a1","PI","a2","c","beginPath","moveTo","lineTo","cos","sin","arc","fillStyle","fill","isPoly","props","def","i","a","d","isPolygon","strokeStyle","lineWidth","max","stroke","r","ellipse","boundingRect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","sqrt","atan2","AbstractPlugin","id"],"mappings":"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"}