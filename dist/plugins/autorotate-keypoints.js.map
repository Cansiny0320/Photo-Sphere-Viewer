{"version":3,"file":"autorotate-keypoints.js","sources":["../../src/plugins/autorotate-keypoints/index.js"],"sourcesContent":["import { AbstractPlugin, CONSTANTS, PSVError, utils } from '../..';\n\n\n/**\n * @typedef {PSV.ExtendedPosition|string|Object} PSV.plugins.AutorotateKeypointsPlugin.Keypoints\n * @summary Definition of keypoints for automatic rotation, can be a position object, a marker id or an object with the following properties\n * @property {string} [markerId]\n * @property {PSV.ExtendedPosition} [position]\n * @property {string|{content: string, position: string}} [tooltip]\n * @property {number} [pause=0]\n */\n\n/**\n * @typedef {Object} PSV.plugins.AutorotateKeypointsPlugin.Options\n * @property {boolean} [startFromClosest=true] - start from the closest keypoint instead of the first keypoint\n * @property {PSV.plugins.AutorotateKeypointsPlugin.Keypoints[]} keypoints\n */\n\n\nconst NUM_STEPS = 16;\n\nfunction serializePt(position) {\n  return [position.longitude, position.latitude];\n}\n\n\n/**\n * @summary Replaces the standard autorotate animation by a smooth transition between multiple points\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class AutorotateKeypointsPlugin extends AbstractPlugin {\n\n  static id = 'autorotate-keypoints';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.AutorotateKeypointsPlugin.Options} [options]\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {Object}\n     * @property {number} idx -  current index in keypoints\n     * @property {number[][]} curve - curve between idx and idx + 1\n     * @property {number[]} startPt - start point of the current step\n     * @property {number[]} endPt - end point of the current step\n     * @property {number} startTime - start time of the current step\n     * @property {number} stepDuration - expected duration of the step\n     * @property {number} remainingPause - time remaining for the pause\n     * @property {number} lastTime - previous timestamp in render loop\n     * @property {PSV.components.Tooltip} tooltip - currently displayed tooltip\n     * @private\n     */\n    this.state = {};\n\n    /**\n     * @member {PSV.plugins.AutorotateKeypointsPlugin.Options}\n     * @private\n     */\n    this.config = {\n      startFromClosest: true,\n      ...options,\n    };\n\n    /**\n     * @type {PSV.plugins.AutorotateKeypointsPlugin.Keypoints[]} keypoints\n     */\n    this.keypoints = null;\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n\n    if (this.config.keypoints) {\n      this.setKeypoints(this.config.keypoints);\n      delete this.config.keypoints;\n    }\n\n    this.psv.on(CONSTANTS.EVENTS.AUTOROTATE, this);\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.AUTOROTATE, this);\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n\n    delete this.markers;\n    delete this.keypoints;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    if (e.type === CONSTANTS.EVENTS.AUTOROTATE) {\n      this.__configure();\n    }\n    else if (e.type === CONSTANTS.EVENTS.BEFORE_RENDER) {\n      this.__beforeRender(e.args[0]);\n    }\n  }\n\n  /**\n   * @summary Changes the keypoints\n   * @param {PSV.plugins.AutorotateKeypointsPlugin.Keypoints[]} keypoints\n   */\n  setKeypoints(keypoints) {\n    if (keypoints?.length < 2) {\n      throw new PSVError('At least two points are required');\n    }\n\n    this.keypoints = utils.clone(keypoints);\n\n    if (this.keypoints) {\n      this.keypoints.forEach((pt, i) => {\n        if (typeof pt === 'string') {\n          pt = { markerId: pt };\n        }\n        else if (utils.isExtendedPosition(pt)) {\n          pt = { position: pt };\n        }\n        if (pt.markerId) {\n          if (!this.markers) {\n            throw new PSVError(`Keypoint #${i} references a marker but markers plugin is not loaded`);\n          }\n          const marker = this.markers.getMarker(pt.markerId);\n          pt.position = serializePt(marker.props.position);\n        }\n        else if (pt.position) {\n          pt.position = serializePt(this.psv.dataHelper.cleanPosition(pt.position));\n        }\n        else {\n          throw new PSVError(`Keypoint #${i} is missing marker or position`);\n        }\n\n        if (typeof pt.tooltip === 'string') {\n          pt.tooltip = { content: pt.tooltip };\n        }\n\n        this.keypoints[i] = pt;\n      });\n    }\n\n    this.__configure();\n  }\n\n  /**\n   * @private\n   */\n  __configure() {\n    if (!this.psv.isAutorotateEnabled() || !this.keypoints) {\n      this.__hideTooltip();\n      this.state = {};\n      return;\n    }\n\n    // cancel core rotation\n    this.psv.dynamics.position.stop();\n\n    this.state = {\n      idx           : -1,\n      curve         : [],\n      startPt       : null,\n      endPt         : null,\n      startTime     : null,\n      stepDuration  : null,\n      remainingPause: null,\n      lastTime      : null,\n      tooltip       : null,\n    };\n\n    if (this.config.startFromClosest) {\n      const currentPosition = serializePt(this.psv.getPosition());\n      const index = this.__findMinIndex(this.keypoints, (keypoint) => {\n        return utils.greatArcDistance(keypoint.position, currentPosition);\n      });\n\n      this.keypoints.push(...this.keypoints.splice(0, index));\n    }\n  }\n\n  /**\n   * @private\n   */\n  __beforeRender(timestamp) {\n    if (this.psv.isAutorotateEnabled()) {\n      // initialisation\n      if (!this.state.startTime) {\n        this.state.endPt = serializePt(this.psv.getPosition());\n        this.__nextStep();\n\n        this.state.startTime = timestamp;\n        this.state.lastTime = timestamp;\n      }\n\n      this.__nextFrame(timestamp);\n    }\n  }\n\n  /**\n   * @private\n   */\n  __incrementIdx() {\n    this.state.idx++;\n    if (this.state.idx === this.keypoints.length) {\n      this.state.idx = 0;\n    }\n  }\n\n  /**\n   * @private\n   */\n  __showTooltip() {\n    const keypoint = this.keypoints[this.state.idx];\n\n    if (keypoint.tooltip) {\n      const position = this.psv.dataHelper.vector3ToViewerCoords(this.psv.prop.direction);\n\n      this.state.tooltip = this.psv.tooltip.create({\n        content : keypoint.tooltip.content,\n        position: keypoint.tooltip.position,\n        top     : position.y,\n        left    : position.x,\n      });\n    }\n    else if (keypoint.markerId) {\n      const marker = this.markers.getMarker(keypoint.markerId);\n      marker.showTooltip();\n      this.state.tooltip = marker.tooltip;\n    }\n  }\n\n  /**\n   * @private\n   */\n  __hideTooltip() {\n    if (this.state.tooltip) {\n      const keypoint = this.keypoints[this.state.idx];\n\n      if (keypoint.tooltip) {\n        this.state.tooltip.hide();\n      }\n      else if (keypoint.markerId) {\n        const marker = this.markers.getMarker(keypoint.markerId);\n        marker.hideTooltip();\n      }\n\n      this.state.tooltip = null;\n    }\n  }\n\n  /**\n   * @private\n   */\n  __nextPoint() {\n    // get the 4 points necessary to compute the current movement\n    // one point before and two points before current\n    const workPoints = [];\n    if (this.state.idx === -1) {\n      const currentPosition = serializePt(this.psv.getPosition());\n      workPoints.push(\n        currentPosition,\n        currentPosition,\n        this.keypoints[0].position,\n        this.keypoints[1].position\n      );\n    }\n    else {\n      for (let i = -1; i < 3; i++) {\n        const keypoint = this.state.idx + i < 0\n          ? this.keypoints[this.keypoints.length - 1]\n          : this.keypoints[(this.state.idx + i) % this.keypoints.length];\n        workPoints.push(keypoint.position);\n      }\n    }\n\n    // apply offsets to avoid crossing the origin\n    const workPoints2 = [workPoints[0].slice(0)];\n\n    let k = 0;\n    for (let i = 1; i <= 3; i++) {\n      const d = workPoints[i - 1][0] - workPoints[i][0];\n      if (d > Math.PI) { // crossed the origin left to right\n        k += 1;\n      }\n      else if (d < -Math.PI) { // crossed the origin right to left\n        k -= 1;\n      }\n      if (k !== 0 && i === 1) {\n        // do not modify first point, apply the reverse offset the the previous point instead\n        workPoints2[0][0] -= k * 2 * Math.PI;\n        k = 0;\n      }\n      workPoints2.push([workPoints[i][0] + k * 2 * Math.PI, workPoints[i][1]]);\n    }\n\n    // only keep the curve for the current movement\n    this.state.curve = this.__getCurvePoints(workPoints2, 0.6, NUM_STEPS)\n      .slice(NUM_STEPS, NUM_STEPS * 2);\n\n    if (this.state.idx !== -1) {\n      this.state.remainingPause = this.keypoints[this.state.idx].pause;\n\n      if (this.state.remainingPause) {\n        this.__showTooltip();\n      }\n      else {\n        this.__incrementIdx();\n      }\n    }\n    else {\n      this.__incrementIdx();\n    }\n  }\n\n  /**\n   * @private\n   */\n  __nextStep() {\n    if (this.state.curve.length === 0) {\n      this.__nextPoint();\n\n      // reset transformation made to the previous point\n      this.state.endPt[0] = utils.parseAngle(this.state.endPt[0]);\n    }\n\n    // target next point\n    this.state.startPt = this.state.endPt;\n    this.state.endPt = this.state.curve.shift();\n\n    // compute duration from distance and speed\n    const distance = utils.greatArcDistance(this.state.startPt, this.state.endPt);\n    this.state.stepDuration = distance * 1000 / Math.abs(this.psv.config.autorotateSpeed);\n\n    if (distance === 0) { // edge case\n      this.__nextStep();\n    }\n  }\n\n  /**\n   * @private\n   */\n  __nextFrame(timestamp) {\n    const ellapsed = timestamp - this.state.lastTime;\n    this.state.lastTime = timestamp;\n\n    // currently paused\n    if (this.state.remainingPause) {\n      this.state.remainingPause = Math.max(0, this.state.remainingPause - ellapsed);\n      if (this.state.remainingPause > 0) {\n        return;\n      }\n      else {\n        this.__hideTooltip();\n        this.__incrementIdx();\n        this.state.startTime = timestamp;\n      }\n    }\n\n    let progress = (timestamp - this.state.startTime) / this.state.stepDuration;\n    if (progress >= 1) {\n      this.__nextStep();\n      progress = 0;\n      this.state.startTime = timestamp;\n    }\n\n    this.psv.rotate({\n      longitude: this.state.startPt[0] + (this.state.endPt[0] - this.state.startPt[0]) * progress,\n      latitude : this.state.startPt[1] + (this.state.endPt[1] - this.state.startPt[1]) * progress,\n    }, true);\n  }\n\n  /**\n   * @summary Interpolate curvature points using cardinal spline\n   * {@link https://stackoverflow.com/a/15528789/1207670}\n   * @param {number[][]} pts\n   * @param {number} [tension=0.5]\n   * @param {number} [numOfSegments=16]\n   * @returns {number[][]}\n   * @private\n   */\n  __getCurvePoints(pts, tension = 0.5, numOfSegments = 16) {\n    const res = [];\n\n    // The algorithm require a previous and next point to the actual point array.\n    const _pts = pts.slice(0);\n    _pts.unshift(pts[0]);\n    _pts.push(pts[pts.length - 1]);\n\n    // 1. loop through each point\n    // 2. loop through each segment\n    for (let i = 1; i < _pts.length - 2; i++) {\n      // calc tension vectors\n      const t1x = (_pts[i + 1][0] - _pts[i - 1][0]) * tension;\n      const t2x = (_pts[i + 2][0] - _pts[i][0]) * tension;\n\n      const t1y = (_pts[i + 1][1] - _pts[i - 1][1]) * tension;\n      const t2y = (_pts[i + 2][1] - _pts[i][1]) * tension;\n\n      for (let t = 1; t <= numOfSegments; t++) {\n        // calc step\n        const st = t / numOfSegments;\n\n        const st3 = Math.pow(st, 3);\n        const st2 = Math.pow(st, 2);\n\n        // calc cardinals\n        const c1 = 2 * st3 - 3 * st2 + 1;\n        const c2 = -2 * st3 + 3 * st2;\n        const c3 = st3 - 2 * st2 + st;\n        const c4 = st3 - st2;\n\n        // calc x and y cords with common control vectors\n        const x = c1 * _pts[i][0] + c2 * _pts[i + 1][0] + c3 * t1x + c4 * t2x;\n        const y = c1 * _pts[i][1] + c2 * _pts[i + 1][1] + c3 * t1y + c4 * t2y;\n\n        // store points in array\n        res.push([x, y]);\n      }\n    }\n\n    return res;\n  }\n\n  __findMinIndex(array, mapper) {\n    let idx = 0;\n    let current = Number.MAX_VALUE;\n\n    array.forEach((item, i) => {\n      const value = mapper ? mapper(item) : item;\n      if (value < current) {\n        current = value;\n        idx = i;\n      }\n    });\n\n    return idx;\n  }\n\n}\n"],"names":["NUM_STEPS","serializePt","position","longitude","latitude","AutorotateKeypointsPlugin","psv","options","state","config","startFromClosest","keypoints","markers","init","getPlugin","setKeypoints","on","CONSTANTS","EVENTS","AUTOROTATE","BEFORE_RENDER","destroy","off","handleEvent","e","type","__configure","__beforeRender","args","length","PSVError","utils","clone","forEach","pt","i","markerId","isExtendedPosition","marker","getMarker","props","dataHelper","cleanPosition","tooltip","content","isAutorotateEnabled","__hideTooltip","dynamics","stop","idx","curve","startPt","endPt","startTime","stepDuration","remainingPause","lastTime","currentPosition","getPosition","index","__findMinIndex","keypoint","greatArcDistance","push","splice","timestamp","__nextStep","__nextFrame","__incrementIdx","__showTooltip","vector3ToViewerCoords","prop","direction","create","top","y","left","x","showTooltip","hide","hideTooltip","__nextPoint","workPoints","workPoints2","slice","k","d","Math","PI","__getCurvePoints","pause","parseAngle","shift","distance","abs","autorotateSpeed","ellapsed","max","progress","rotate","pts","tension","numOfSegments","res","_pts","unshift","t1x","t2x","t1y","t2y","t","st","st3","pow","st2","c1","c2","c3","c4","array","mapper","current","Number","MAX_VALUE","item","value","AbstractPlugin","id"],"mappings":"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"}