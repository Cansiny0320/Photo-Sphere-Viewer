{"version":3,"file":"virtual-tour.js","sources":["../../src/plugins/virtual-tour/AbstractDatasource.js","../../src/plugins/virtual-tour/utils.js","../../src/plugins/virtual-tour/ClientSideDatasource.js","../../src/plugins/virtual-tour/constants.js","../../src/plugins/virtual-tour/ServerSideDatasource.js","../../src/plugins/virtual-tour/index.js"],"sourcesContent":["import { PSVError } from 'photo-sphere-viewer';\n\n/**\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @package\n */\nexport class AbstractDatasource {\n\n  /**\n   * @type {Record<string, PSV.plugins.VirtualTourPlugin.Node>}\n   */\n  nodes = {};\n\n  /**\n   * @param {PSV.plugins.VirtualTourPlugin} plugin\n   */\n  constructor(plugin) {\n    this.plugin = plugin;\n  }\n\n  destroy() {\n    delete this.plugin;\n  }\n\n  /**\n   * @summary Loads a node\n   * @param {string} nodeId\n   * @return {Promise<PSV.plugins.VirtualTourPlugin.Node>}\n   */\n  loadNode(nodeId) { // eslint-disable-line no-unused-vars\n    throw new PSVError('loadNode not implemented');\n  }\n\n  /**\n   * @summary Loades nodes linked to another node\n   * @param {string} nodeId\n   * @return {Promise<void>}\n   */\n  loadLinkedNodes(nodeId) { // eslint-disable-line no-unused-vars\n    throw new PSVError('loadLinkedNodes not implemented');\n  }\n\n}\n","import { PSVError, utils } from 'photo-sphere-viewer';\n\n/**\n * @summary Checks the configuration of a node\n * @param {PSV.plugins.VirtualTourPlugin.Node} node\n * @param {boolean} isGps\n * @private\n */\nexport function checkNode(node, isGps) {\n  if (!node.id) {\n    throw new PSVError('No id given for node');\n  }\n  if (!node.panorama) {\n    throw new PSVError(`No panorama provided for node ${node.id}`);\n  }\n  if (isGps && !(node.position?.length >= 2)) {\n    throw new PSVError(`No position provided for node ${node.id}`);\n  }\n}\n\n/**\n * @summary Checks the configuration of a link\n * @param {PSV.plugins.VirtualTourPlugin.Node} node\n * @param {PSV.plugins.VirtualTourPlugin.NodeLink} link\n * @param {boolean} isGps\n * @private\n */\nexport function checkLink(node, link, isGps) {\n  if (!link.nodeId) {\n    throw new PSVError(`Link of node ${node.id} has no target id`);\n  }\n  if (!isGps && !utils.isExtendedPosition(link)) {\n    throw new PSVError(`No position provided for link ${link.nodeId} of node ${node.id}`);\n  }\n}\n\n/**\n * @summary Changes the color of a mesh\n * @param {external:THREE.Mesh} mesh\n * @param {*} color\n * @private\n */\nexport function setMeshColor(mesh, color) {\n  mesh.material.color.set(color);\n  mesh.material.emissive.set(color);\n}\n\n/**\n * @summary Returns the distance between two GPS points\n * @param {number[]} p1\n * @param {number[]} p2\n * @return {number}\n * @private\n */\nexport function distance(p1, p2) {\n  return utils.greatArcDistance(p1, p2) * 6371e3;\n}\n\n/**\n * @summary Returns the bearing between two GPS points\n * {@link http://www.movable-type.co.uk/scripts/latlong.html}\n * @param {number[]} p1\n * @param {number[]} p2\n * @return {number}\n * @private\n */\nexport function bearing(p1, p2) {\n  const [λ1, φ1] = p1;\n  const [λ2, φ2] = p2;\n\n  const y = Math.sin(λ2 - λ1) * Math.cos(φ2);\n  const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);\n  return Math.atan2(y, x);\n}\n","import { PSVError, utils } from 'photo-sphere-viewer';\nimport { AbstractDatasource } from './AbstractDatasource';\nimport { checkLink, checkNode } from './utils';\n\n/**\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @package\n */\nexport class ClientSideDatasource extends AbstractDatasource {\n\n  loadNode(nodeId) {\n    if (this.nodes[nodeId]) {\n      return Promise.resolve(this.nodes[nodeId]);\n    }\n    else {\n      return Promise.reject(new PSVError(`Node ${nodeId} not found`));\n    }\n  }\n\n  loadLinkedNodes(nodeId) {\n    if (!this.nodes[nodeId]) {\n      return Promise.reject(new PSVError(`Node ${nodeId} not found`));\n    }\n    else {\n      return Promise.resolve();\n    }\n  }\n\n  setNodes(rawNodes) {\n    if (!rawNodes?.length) {\n      throw new PSVError('No nodes provided');\n    }\n\n    const nodes = {};\n    const linkedNodes = {};\n\n    rawNodes.forEach((node) => {\n      checkNode(node, this.plugin.isGps());\n\n      if (nodes[node.id]) {\n        throw new PSVError(`Duplicate node ${node.id}`);\n      }\n      if (!node.links) {\n        utils.logWarn(`Node ${node.id} has no links`);\n        nodes.links = [];\n      }\n\n      nodes[node.id] = node;\n    });\n\n    rawNodes.forEach((node) => {\n      node.links.forEach((link) => {\n        checkLink(node, link, this.plugin.isGps());\n\n        if (!nodes[link.nodeId]) {\n          throw new PSVError(`Target node ${link.nodeId} of node ${node.id} does not exists`);\n        }\n\n        // copy essential data\n        link.position = link.position || nodes[link.nodeId].position;\n        link.name = link.name || nodes[link.nodeId].name;\n\n        linkedNodes[link.nodeId] = true;\n      });\n    });\n\n    rawNodes.forEach((node) => {\n      if (!linkedNodes[node.id]) {\n        utils.logWarn(`Node ${node.id} is never linked to`);\n      }\n    });\n\n    this.nodes = nodes;\n  }\n\n}\n","import * as THREE from 'three';\nimport arrowGeometryJson from './arrow.json';\nimport arrowIconSvg from './arrow.svg';\n\n/**\n * @summary In client mode all the nodes are provided in the config or with the `setNodes` method\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_CLIENT = 'client';\n\n/**\n * @summary In server mode the nodes are fetched asynchronously\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_SERVER = 'server';\n\n/**\n * @summary In manual mode each link is positionned manually on the panorama\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_MANUAL = 'manual';\n\n/**\n * @summary In GPS mode each node is globally positionned and the links are automatically computed\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_GPS = 'gps';\n\n/**\n * @summaru In markers mode the links are represented using markers\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_MARKERS = 'markers';\n\n/**\n * @summaru In 3D mode the links are represented using 3d arrows\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_3D = '3d';\n\n/**\n * @summary Available events\n * @enum {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const EVENTS = {\n  /**\n   * @event node-changed\n   * @memberof PSV.plugins.VirtualTourPlugin\n   * @summary Triggered when the current node changes\n   * @param {string} nodeId\n   */\n  NODE_CHANGED: 'node-changed',\n};\n\n/**\n * @summary Property name added to markers\n * @type {string}\n * @constant\n * @private\n */\nexport const LINK_DATA = 'tourLink';\n\n/**\n * @summary Default style of the link marker\n * @type {PSV.plugins.MarkersPlugin.Properties}\n * @constant\n * @private\n */\nexport const DEFAULT_MARKER = {\n  html     : arrowIconSvg,\n  width    : 80,\n  height   : 80,\n  scale    : [0.5, 2],\n  anchor   : 'top center',\n  className: 'psv-virtual-tour__marker',\n  style    : {\n    color: 'rgba(0, 208, 255, 0.8)',\n  },\n};\n\n/**\n * @summary Default style of the link arrow\n * @type {PSV.plugins.VirtualTourPlugin.ArrowStyle}\n * @constant\n * @private\n */\nexport const DEFAULT_ARROW = {\n  color     : 0x0055aa,\n  hoverColor: 0xaa5500,\n  opacity   : 0.8,\n  scale     : [0.5, 2],\n};\n\n/**\n * @type {external:THREE.BufferedGeometry}\n * @constant\n * @private\n */\nexport const ARROW_GEOM = (() => {\n  const loader = new THREE.ObjectLoader();\n  const geom = loader.parseGeometries([arrowGeometryJson])[arrowGeometryJson.uuid];\n  geom.scale(0.01, 0.015, 0.015);\n  geom.computeBoundingBox();\n  const b = geom.boundingBox;\n  geom.translate(-(b.max.x - b.min.y) / 2, -(b.max.y - b.min.y) / 2, -(b.max.z - b.min.z) / 2);\n  geom.rotateX(Math.PI);\n  return geom;\n})();\n","import { PSVError } from 'photo-sphere-viewer';\nimport { AbstractDatasource } from './AbstractDatasource';\nimport { checkLink, checkNode } from './utils';\n\n/**\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @package\n */\nexport class ServerSideDatasource extends AbstractDatasource {\n\n  constructor(plugin) {\n    super(plugin);\n\n    if (!plugin.config.getNode || !plugin.config.getLinks) {\n      throw new PSVError('Missing getNode() and/or getLinks() options.');\n    }\n\n    this.nodeResolver = plugin.config.getNode;\n    this.linksResolver = plugin.config.getLinks;\n  }\n\n  loadNode(nodeId) {\n    if (this.nodes[nodeId]) {\n      return Promise.resolve(this.nodes[nodeId]);\n    }\n    else {\n      return Promise.resolve(this.nodeResolver(nodeId))\n        .then((node) => {\n          checkNode(node, this.plugin.isGps());\n          this.nodes[nodeId] = node;\n          return node;\n        });\n    }\n  }\n\n  loadLinkedNodes(nodeId) {\n    if (!this.nodes[nodeId]) {\n      return Promise.reject(new PSVError(`Node ${nodeId} not found`));\n    }\n    else if (this.nodes[nodeId].links) {\n      return Promise.resolve();\n    }\n    else {\n      return Promise.resolve(this.linksResolver(nodeId))\n        .then(links => links || [])\n        .then((links) => {\n          const node = this.nodes[nodeId];\n\n          links.forEach((link) => {\n            checkLink(node, link, this.plugin.isGps());\n\n            // copy essential data\n            if (this.nodes[link.nodeId]) {\n              link.position = link.position || this.nodes[link.nodeId].position;\n              link.name = link.name || this.nodes[link.nodeId].name;\n            }\n\n            if (this.plugin.isGps() && !link.position) {\n              throw new PSVError(`No GPS position provided for link ${link.nodeId} of node ${node.id}`);\n            }\n          });\n\n          // store links\n          node.links = links;\n        });\n    }\n  }\n\n}\n","import { AbstractPlugin, CONSTANTS, DEFAULTS, PSVError, utils } from 'photo-sphere-viewer';\nimport * as THREE from 'three';\nimport { ClientSideDatasource } from './ClientSideDatasource';\nimport {\n  ARROW_GEOM,\n  DEFAULT_ARROW,\n  DEFAULT_MARKER,\n  EVENTS,\n  LINK_DATA,\n  MODE_3D,\n  MODE_CLIENT,\n  MODE_GPS,\n  MODE_MANUAL,\n  MODE_MARKERS,\n  MODE_SERVER\n} from './constants';\nimport { ServerSideDatasource } from './ServerSideDatasource';\nimport './style.scss';\nimport { bearing, distance, setMeshColor } from './utils';\n\n\n/**\n * @callback GetNode\n * @summary Function to load a node\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @param {string} nodeId\n * @returns {PSV.plugins.VirtualTourPlugin.Node|Promise<PSV.plugins.VirtualTourPlugin.Node>}\n */\n\n/**\n * @callback GetLinks\n * @summary Function to load the links of a node\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @param {string} nodeId\n * @returns {PSV.plugins.VirtualTourPlugin.NodeLink[]|Promise<PSV.plugins.VirtualTourPlugin.NodeLink[]>}\n */\n\n/**\n * @callback Preload\n * @summary Function to determine if a link must be preloaded\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @param {PSV.plugins.VirtualTourPlugin.Node} node\n * @param {PSV.plugins.VirtualTourPlugin.NodeLink} link\n * @returns {boolean}\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.Node\n * @summary Definition of a single node in the tour\n * @property {string} id - unique identifier of the node\n * @property {*} panorama\n * @property {PSV.plugins.VirtualTourPlugin.NodeLink[]} [links] - links to other nodes\n * @property {number[]} [position] - GPS position (longitude, latitude, optional altitude)\n * @property {PSV.PanoData | PSV.PanoDataProvider} [panoData] - data used for this panorama\n * @property {PSV.SphereCorrection} [sphereCorrection] - sphere correction to apply to this panorama\n * @property {string} [name] - short name of the node\n * @property {string} [caption] - caption visible in the navbar\n * @property {PSV.plugins.MarkersPlugin.Properties[]} [markers] - additional markers to use on this node\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.VirtualTourPlugin.NodeLink\n * @summary Definition of a link between two nodes\n * @property {string} nodeId - identifier of the target node\n * @property {string} [name] - override the name of the node (tooltip)\n * @property {number[]} [position] - override the GPS position of the node\n * @property {PSV.plugins.MarkersPlugin.Properties} [markerStyle] - override global marker style\n * @property {PSV.plugins.VirtualTourPlugin.ArrowStyle} [arrowStyle] - override global arrow style\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.ArrowStyle\n * @summary Style of the arrow in 3D mode\n * @property {string} [color=#0055aa]\n * @property {string} [hoverColor=#aa5500]\n * @property {number} [opacity=0.8]\n * @property {number[]} [scale=[0.5,2]]\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.Options\n * @property {'client'|'server'} [dataMode='client'] - configure data mode\n * @property {'manual'|'gps'} [positionMode='manual'] - configure positioning mode\n * @property {'markers'|'3d'} [renderMode='3d'] - configure rendering mode of links\n * @property {PSV.plugins.VirtualTourPlugin.Node[]} [nodes] - initial nodes\n * @property {PSV.plugins.VirtualTourPlugin.GetNode} [getNode]\n * @property {PSV.plugins.VirtualTourPlugin.GetLinks} [getLinks]\n * @property {string} [startNodeId] - id of the initial node, if not defined the first node will be used\n * @property {boolean|PSV.plugins.VirtualTourPlugin.Preload} [preload=false] - preload linked panoramas\n * @property {PSV.plugins.MarkersPlugin.Properties} [markerStyle] - global marker style\n * @property {PSV.plugins.VirtualTourPlugin.ArrowStyle} [arrowStyle] - global arrow style\n * @property {number} [markerLatOffset=-0.1] - (GPS & Markers mode) latitude offset applied to link markers, to compensate for viewer height\n * @property {'top'|'bottom'} [arrowPosition='bottom'] - (3D mode) arrows vertical position\n * @property {boolean} [linksOnCompass] - if the Compass plugin is enabled, displays the links on the compass\n */\n\n\nDEFAULTS.lang.loading = 'Loading...';\n\n\nexport { EVENTS, MODE_3D, MODE_CLIENT, MODE_GPS, MODE_MANUAL, MODE_MARKERS, MODE_SERVER } from './constants';\n\n\n/**\n * @summary Create virtual tours by linking multiple panoramas\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class VirtualTourPlugin extends AbstractPlugin {\n\n  static id = 'virtual-tour';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.VirtualTourPlugin.Options} [options]\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {Object}\n     * @property {PSV.plugins.VirtualTourPlugin.Node} currentNode\n     * @property {external:THREE.Mesh} currentArrow\n     * @property {PSV.Tooltip} currentTooltip\n     * @private\n     */\n    this.prop = {\n      currentNode   : null,\n      currentArrow  : null,\n      currentTooltip: null,\n    };\n\n    /**\n     * @type {Record<string, boolean | Promise>}\n     * @private\n     */\n    this.preload = {};\n\n    /**\n     * @member {PSV.plugins.VirtualTourPlugin.Options}\n     * @private\n     */\n    this.config = {\n      dataMode       : MODE_CLIENT,\n      positionMode   : MODE_MANUAL,\n      renderMode     : MODE_3D,\n      preload        : false,\n      markerLatOffset: -0.1,\n      arrowPosition  : 'bottom',\n      linksOnCompass : options?.renderMode === MODE_MARKERS,\n      ...options,\n      markerStyle: {\n        ...DEFAULT_MARKER,\n        ...options?.markerStyle,\n      },\n      arrowStyle : {\n        ...DEFAULT_ARROW,\n        ...options?.arrowStyle,\n      },\n      nodes      : null,\n    };\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = this.psv.getPlugin('markers');\n\n    /**\n     * @type {PSV.plugins.CompassPlugin}\n     * @private\n     */\n    this.compass = this.psv.getPlugin('compass');\n\n    if (!this.is3D() && !this.markers) {\n      throw new PSVError('Tour plugin requires the Markers plugin in markers mode');\n    }\n\n    /**\n     * @type {PSV.plugins.VirtualTourPlugin.AbstractDatasource}\n     */\n    this.datasource = this.isServerSide() ? new ServerSideDatasource(this) : new ClientSideDatasource(this);\n\n    /**\n     * @type {external:THREE.Group}\n     * @private\n     */\n    this.arrowsGroup = null;\n\n    if (this.is3D()) {\n      this.arrowsGroup = new THREE.Group();\n\n      const localLight = new THREE.PointLight(0xffffff, 1, 0);\n      localLight.position.set(2, 0, 0);\n      this.arrowsGroup.add(localLight);\n\n      this.psv.once(CONSTANTS.EVENTS.READY, () => {\n        this.__positionArrows();\n        this.psv.renderer.scene.add(this.arrowsGroup);\n\n        const ambientLight = new THREE.AmbientLight(0xffffff, 1);\n        this.psv.renderer.scene.add(ambientLight);\n\n        this.psv.needsUpdate();\n\n        this.psv.container.addEventListener('mousemove', this);\n      });\n\n      this.psv.on(CONSTANTS.EVENTS.POSITION_UPDATED, this);\n      this.psv.on(CONSTANTS.EVENTS.ZOOM_UPDATED, this);\n      this.psv.on(CONSTANTS.EVENTS.CLICK, this);\n    }\n    else {\n      this.markers.on('select-marker', this);\n    }\n\n    if (this.isServerSide()) {\n      if (this.config.startNodeId) {\n        this.setCurrentNode(this.config.startNodeId);\n      }\n    }\n    else if (options?.nodes) {\n      this.setNodes(options.nodes, this.config.startNodeId);\n    }\n  }\n\n  destroy() {\n    if (this.markers) {\n      this.markers.off('select-marker', this);\n    }\n    if (this.arrowsGroup) {\n      this.psv.renderer.scene.remove(this.arrowsGroup);\n    }\n\n    this.psv.off(CONSTANTS.EVENTS.POSITION_UPDATED, this);\n    this.psv.off(CONSTANTS.EVENTS.ZOOM_UPDATED, this);\n    this.psv.off(CONSTANTS.EVENTS.CLICK, this);\n    this.psv.container.removeEventListener('mousemove', this);\n\n    this.datasource.destroy();\n\n    delete this.preload;\n    delete this.datasource;\n    delete this.markers;\n    delete this.prop;\n    delete this.arrowsGroup;\n\n    super.destroy();\n  }\n\n  handleEvent(e) {\n    let nodeId;\n    switch (e.type) {\n      case 'select-marker':\n        nodeId = e.args[0].data?.[LINK_DATA]?.nodeId;\n        if (nodeId) {\n          this.setCurrentNode(nodeId);\n        }\n        break;\n\n      case CONSTANTS.EVENTS.POSITION_UPDATED:\n      case CONSTANTS.EVENTS.ZOOM_UPDATED:\n        if (this.arrowsGroup) {\n          this.__positionArrows();\n        }\n        break;\n\n      case CONSTANTS.EVENTS.CLICK:\n        nodeId = this.prop.currentArrow?.userData?.[LINK_DATA]?.nodeId;\n        if (!nodeId) {\n          // on touch screens \"currentArrow\" may be null (no hover state)\n          const arrow = this.psv.dataHelper.getIntersection({ x: e.args[0].viewerX, y: e.args[0].viewerY }, LINK_DATA)?.object;\n          nodeId = arrow?.userData?.[LINK_DATA]?.nodeId;\n        }\n        if (nodeId) {\n          this.setCurrentNode(nodeId);\n        }\n        break;\n\n      case 'mousemove':\n        this.__onMouseMove(e);\n        break;\n\n      default:\n    }\n  }\n\n  /**\n   * @summary Tests if running in server mode\n   * @return {boolean}\n   */\n  isServerSide() {\n    return this.config.dataMode === MODE_SERVER;\n  }\n\n  /**\n   * @summary Tests if running in GPS mode\n   * @return {boolean}\n   */\n  isGps() {\n    return this.config.positionMode === MODE_GPS;\n  }\n\n  /**\n   * @summary Tests if running in 3D mode\n   * @return {boolean}\n   */\n  is3D() {\n    return this.config.renderMode === MODE_3D;\n  }\n\n  /**\n   * @summary Sets the nodes (client mode only)\n   * @param {PSV.plugins.VirtualTourPlugin.Node[]} nodes\n   * @param {string} [startNodeId]\n   * @throws {PSV.PSVError} when the configuration is incorrect\n   */\n  setNodes(nodes, startNodeId) {\n    if (this.isServerSide()) {\n      throw new PSVError('Cannot set nodes in server side mode');\n    }\n\n    this.datasource.setNodes(nodes);\n\n    if (!startNodeId) {\n      startNodeId = nodes[0].id;\n    }\n    else if (!this.datasource.nodes[startNodeId]) {\n      startNodeId = nodes[0].id;\n      utils.logWarn(`startNodeId not found is provided nodes, resetted to ${startNodeId}`);\n    }\n\n    this.setCurrentNode(startNodeId);\n  }\n\n  /**\n   * @summary Changes the current node\n   * @param {string} nodeId\n   */\n  setCurrentNode(nodeId) {\n    this.psv.loader.show();\n    this.psv.hideError();\n\n    // if this node is already preloading, wait for it\n    return Promise.resolve(this.preload[nodeId])\n      .then(() => {\n        this.psv.textureLoader.abortLoading();\n        return this.datasource.loadNode(nodeId);\n      })\n      .then((node) => {\n        this.psv.navbar.setCaption(`<em>${this.psv.config.lang.loading}</em>`);\n\n        this.prop.currentNode = node;\n\n        if (this.prop.currentTooltip) {\n          this.prop.currentTooltip.hide();\n          this.prop.currentTooltip = null;\n        }\n\n        if (this.is3D()) {\n          this.arrowsGroup.remove(...this.arrowsGroup.children.filter(o => o.type === 'Mesh'));\n          this.prop.currentArrow = null;\n        }\n        else {\n          this.markers.clearMarkers();\n        }\n\n        if (this.config.linksOnCompass && this.compass) {\n          this.compass.setHotspots(null);\n        }\n\n        return Promise.all([\n          this.psv.setPanorama(node.panorama, {\n            panoData        : node.panoData,\n            sphereCorrection: node.sphereCorrection,\n          })\n            // eslint-disable-next-line prefer-promise-reject-errors\n            .catch(() => Promise.reject(null)), // the error is already displayed by the core\n          this.datasource.loadLinkedNodes(nodeId),\n        ]);\n      })\n      .then(() => {\n        const node = this.prop.currentNode;\n\n        if (node.markers) {\n          if (this.markers) {\n            this.markers.setMarkers(node.markers);\n          }\n          else {\n            utils.logWarn(`Node ${node.id} markers ignored because the plugin is not loaded.`);\n          }\n        }\n\n        this.__renderLinks(node);\n        this.__preload(node);\n\n        this.psv.navbar.setCaption(node.caption || this.psv.config.caption);\n\n        /**\n         * @event node-changed\n         * @memberof PSV.plugins.VirtualTourPlugin\n         * @summary Triggered when the current node is changed\n         * @param {string} nodeId\n         */\n        this.trigger(EVENTS.NODE_CHANGED, nodeId);\n      })\n      .catch((err) => {\n        this.psv.loader.hide();\n        this.psv.navbar.setCaption('');\n\n        if (err) {\n          this.psv.showError(this.psv.config.lang.loadError);\n        }\n\n        return Promise.reject(err);\n      });\n  }\n\n  /**\n   * @summary Adds the links for the node\n   * @param {PSV.plugins.VirtualTourPlugin.Node} node\n   * @private\n   */\n  __renderLinks(node) {\n    const positions = [];\n\n    node.links.forEach((link) => {\n      const position = this.__getLinkPosition(node, link);\n      positions.push(position);\n\n      if (this.is3D()) {\n        const arrow = ARROW_GEOM.clone();\n        const mat = new THREE.MeshLambertMaterial({\n          transparent: true,\n          opacity    : link.arrowStyle?.opacity || this.config.arrowStyle.opacity,\n        });\n        const mesh = new THREE.Mesh(arrow, mat);\n\n        setMeshColor(mesh, link.arrowStyle?.color || this.config.arrowStyle.color);\n\n        mesh.userData = { [LINK_DATA]: link, longitude  : position.longitude };\n        mesh.rotation.order = 'YXZ';\n        mesh.rotateY(-position.longitude);\n        this.psv.dataHelper\n          .sphericalCoordsToVector3({ longitude: position.longitude, latitude : 0 }, mesh.position)\n          .multiplyScalar(1 / CONSTANTS.SPHERE_RADIUS);\n\n        this.arrowsGroup.add(mesh);\n      }\n      else {\n        if (this.isGps()) {\n          position.latitude += this.config.markerLatOffset;\n        }\n\n        this.markers.addMarker({\n          ...this.config.markerStyle,\n          ...link.markerStyle,\n          id      : `tour-link-${link.nodeId}`,\n          tooltip : link.name,\n          hideList: true,\n          data    : { [LINK_DATA]: link },\n          ...position,\n        }, false);\n      }\n    });\n\n    if (this.is3D()) {\n      this.__positionArrows();\n    }\n    else {\n      this.markers.renderMarkers();\n    }\n\n    if (this.config.linksOnCompass && this.compass) {\n      this.compass.setHotspots(positions);\n    }\n  }\n\n  /**\n   * @summary Computes the marker position for a link\n   * @param {PSV.plugins.VirtualTourPlugin.Node} node\n   * @param {PSV.plugins.VirtualTourPlugin.NodeLink} link\n   * @return {PSV.Position}\n   * @private\n   */\n  __getLinkPosition(node, link) {\n    if (this.isGps()) {\n      const p1 = [THREE.Math.degToRad(node.position[0]), THREE.Math.degToRad(node.position[1])];\n      const p2 = [THREE.Math.degToRad(link.position[0]), THREE.Math.degToRad(link.position[1])];\n      const h1 = node.position[2] !== undefined ? node.position[2] : link.position[2] || 0;\n      const h2 = link.position[2] !== undefined ? link.position[2] : node.position[2] || 0;\n\n      let latitude = 0;\n      if (h1 !== h2) {\n        latitude = Math.atan((h2 - h1) / distance(p1, p2));\n      }\n\n      const longitude = bearing(p1, p2);\n\n      return { longitude, latitude };\n    }\n    else {\n      return this.psv.dataHelper.cleanPosition(link);\n    }\n  }\n\n  /**\n   * @summary Updates hovered arrow on mousemove\n   * @param {MouseEvent} evt\n   * @private\n   */\n  __onMouseMove(evt) {\n    const viewerPos = utils.getPosition(this.psv.container);\n    const viewerPoint = {\n      x: evt.clientX - viewerPos.left,\n      y: evt.clientY - viewerPos.top,\n    };\n\n    const mesh = this.psv.dataHelper.getIntersection(viewerPoint, LINK_DATA)?.object;\n\n    if (mesh === this.prop.currentArrow) {\n      if (this.prop.currentTooltip) {\n        this.prop.currentTooltip.move({\n          left: viewerPoint.x,\n          top : viewerPoint.y,\n        });\n      }\n    }\n    else {\n      if (this.prop.currentArrow) {\n        const link = this.prop.currentArrow.userData[LINK_DATA];\n\n        setMeshColor(this.prop.currentArrow, link.arrowStyle?.color || this.config.arrowStyle.color);\n\n        if (this.prop.currentTooltip) {\n          this.prop.currentTooltip.hide();\n          this.prop.currentTooltip = null;\n        }\n      }\n\n      if (mesh) {\n        const link = mesh.userData[LINK_DATA];\n\n        setMeshColor(mesh, link.arrowStyle?.hoverColor || this.config.arrowStyle.hoverColor);\n\n        if (link.name) {\n          this.prop.currentTooltip = this.psv.tooltip.create({\n            left   : viewerPoint.x,\n            top    : viewerPoint.y,\n            content: link.name,\n          });\n        }\n      }\n\n      this.prop.currentArrow = mesh;\n\n      this.psv.needsUpdate();\n    }\n  }\n\n  /**\n   * @summary Updates to position of the group of arrows\n   * @private\n   */\n  __positionArrows() {\n    const isBottom = this.config.arrowPosition === 'bottom';\n\n    this.arrowsGroup.position.copy(this.psv.prop.direction).multiplyScalar(0.5);\n    const s = this.config.arrowStyle.scale;\n    const f = s[1] + (s[0] - s[1]) * CONSTANTS.EASINGS.linear(this.psv.getZoomLevel() / 100);\n    this.arrowsGroup.position.y += isBottom ? -1.5 : 1.5;\n    this.arrowsGroup.scale.set(f, f, f);\n\n    // slightly rotates each arrow to make the center ones standing out\n    const position = this.psv.getPosition();\n    if (isBottom ? (position.latitude < Math.PI / 8) : (position.latitude > -Math.PI / 8)) {\n      this.arrowsGroup.children\n        .filter(o => o.type === 'Mesh')\n        .forEach((arrow) => {\n          const d = Math.abs(utils.getShortestArc(arrow.userData.longitude, position.longitude));\n          const x = CONSTANTS.EASINGS.inOutSine(Math.max(0, Math.PI / 4 - d) / (Math.PI / 4)) / 3; // magic !\n          arrow.rotation.x = isBottom ? -x : x;\n        });\n    }\n    else {\n      this.arrowsGroup.children\n        .filter(o => o.type === 'Mesh')\n        .forEach((arrow) => {\n          arrow.rotation.x = 0;\n        });\n    }\n  }\n\n  /**\n   * @summary Manage the preload of the linked panoramas\n   * @param {PSV.plugins.VirtualTourPlugin.Node} node\n   * @private\n   */\n  __preload(node) {\n    if (!this.config.preload || !this.isServerSide()) {\n      return;\n    }\n\n    this.preload[node.id] = true;\n\n    this.prop.currentNode.links\n      .filter(link => !this.preload[link.nodeId])\n      .filter((link) => {\n        if (typeof this.config.preload === 'function') {\n          return this.config.preload(this.prop.currentNode, link);\n        }\n        else {\n          return true;\n        }\n      })\n      .forEach((link) => {\n        this.preload[link.nodeId] = this.datasource.loadNode(link.nodeId)\n          .then((linkNode) => {\n            return this.psv.textureLoader.preloadPanorama(linkNode.panorama);\n          })\n          .then(() => {\n            this.preload[link.nodeId] = true;\n          })\n          .catch(() => {\n            delete this.preload[link.nodeId];\n          });\n      });\n  }\n\n}\n"],"names":["AbstractDatasource","plugin","nodes","destroy","loadNode","nodeId","PSVError","loadLinkedNodes","checkNode","node","isGps","id","panorama","position","length","checkLink","link","utils","isExtendedPosition","setMeshColor","mesh","color","material","set","emissive","distance","p1","p2","greatArcDistance","bearing","λ1","φ1","λ2","φ2","y","Math","sin","cos","x","atan2","ClientSideDatasource","Promise","resolve","reject","setNodes","rawNodes","linkedNodes","forEach","links","logWarn","name","MODE_CLIENT","MODE_SERVER","MODE_MANUAL","MODE_GPS","MODE_MARKERS","MODE_3D","EVENTS","NODE_CHANGED","LINK_DATA","DEFAULT_MARKER","html","arrowIconSvg","width","height","scale","anchor","className","style","DEFAULT_ARROW","hoverColor","opacity","ARROW_GEOM","loader","THREE","ObjectLoader","geom","parseGeometries","arrowGeometryJson","uuid","computeBoundingBox","b","boundingBox","translate","max","min","z","rotateX","PI","ServerSideDatasource","config","getNode","getLinks","nodeResolver","linksResolver","then","DEFAULTS","lang","loading","VirtualTourPlugin","psv","options","prop","currentNode","currentArrow","currentTooltip","preload","dataMode","positionMode","renderMode","markerLatOffset","arrowPosition","linksOnCompass","markerStyle","arrowStyle","markers","getPlugin","compass","is3D","datasource","isServerSide","arrowsGroup","Group","localLight","PointLight","add","once","CONSTANTS","READY","__positionArrows","renderer","scene","ambientLight","AmbientLight","needsUpdate","container","addEventListener","on","POSITION_UPDATED","ZOOM_UPDATED","CLICK","startNodeId","setCurrentNode","off","remove","removeEventListener","handleEvent","e","type","args","data","userData","arrow","dataHelper","getIntersection","viewerX","viewerY","object","__onMouseMove","show","hideError","textureLoader","abortLoading","navbar","setCaption","hide","children","filter","o","clearMarkers","setHotspots","all","setPanorama","panoData","sphereCorrection","catch","setMarkers","__renderLinks","__preload","caption","trigger","err","showError","loadError","positions","__getLinkPosition","push","clone","mat","MeshLambertMaterial","transparent","Mesh","longitude","rotation","order","rotateY","sphericalCoordsToVector3","latitude","multiplyScalar","SPHERE_RADIUS","addMarker","tooltip","hideList","renderMarkers","degToRad","h1","undefined","h2","atan","cleanPosition","evt","viewerPos","getPosition","viewerPoint","clientX","left","clientY","top","move","create","content","isBottom","copy","direction","s","f","EASINGS","linear","getZoomLevel","d","abs","getShortestArc","inOutSine","linkNode","preloadPanorama","AbstractPlugin"],"mappings":"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"}