{"version":3,"file":"cubemap-video.js","sources":["../../src/adapters/shared/AbstractVideoAdapter.js","../../src/adapters/cubemap-video/index.js"],"sourcesContent":["import * as THREE from 'three';\nimport { AbstractAdapter, CONSTANTS, PSVError } from '../..';\n\n/**\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Video\n * @summary Object defining a video\n * @property {string} source\n */\n\n/**\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Options\n * @property {boolean} [autoplay=false] - automatically start the video\n * @property {boolean} [muted=autoplay] - initially mute the video\n */\n\n/**\n * @summary Base video adapters class\n * @memberof PSV.adapters\n * @abstract\n * @private\n */\nexport class AbstractVideoAdapter extends AbstractAdapter {\n\n  static supportsTransition = false;\n  static supportsPreload = false;\n  static supportsDownload = false;\n\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.adapters.AbstractVideoAdapter.Options}\n     * @private\n     */\n    this.config = {\n      autoplay: false,\n      muted   : options?.autoplay ?? false,\n      ...options,\n    };\n\n    /**\n     * @member {HTMLVideoElement}\n     * @private\n     */\n    this.video = null;\n\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n  }\n\n  /**\n   * @override\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n\n    this.__removeVideo();\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    /* eslint-disable */\n    switch (e.type) {\n      case CONSTANTS.EVENTS.BEFORE_RENDER:\n        if (this.video) {\n          this.psv.needsUpdate();\n        }\n        break;\n    }\n    /* eslint-enable */\n  }\n\n  /**\n   * @override\n   * @param {PSV.adapters.AbstractVideoAdapter.Video} panorama\n   * @returns {Promise.<PSV.TextureData>}\n   */\n  loadTexture(panorama) {\n    if (typeof panorama !== 'object' || !panorama.source) {\n      return Promise.reject(new PSVError('Invalid panorama configuration, are you using the right adapter?'));\n    }\n\n    if (!this.psv.getPlugin('video')) {\n      return Promise.reject(new PSVError('Video adapters require VideoPlugin to be loaded too.'));\n    }\n\n    const video = this.__createVideo(panorama.source);\n\n    return this.__videoLoadPromise(video)\n      .then(() => {\n        const texture = new THREE.VideoTexture(video);\n        return { panorama, texture };\n      });\n  }\n\n  /**\n   * @override\n   */\n  __switchVideo(texture) {\n    let currentTime;\n    let duration;\n    let paused = !this.config.autoplay;\n    let muted = this.config.muted;\n    let volume = 1;\n    if (this.video) {\n      ({ currentTime, duration, paused, muted, volume } = this.video);\n    }\n\n    this.__removeVideo();\n    this.video = texture.image;\n\n    // keep current time when switching resolution\n    if (this.video.duration === duration) {\n      this.video.currentTime = currentTime;\n    }\n\n    // keep volume\n    this.video.muted = muted;\n    this.video.volume = volume;\n\n    // play\n    if (!paused) {\n      this.video.play();\n    }\n  }\n\n  /**\n   * @override\n   */\n  disposeTexture(textureData) {\n    if (textureData.texture) {\n      const video = textureData.texture.image;\n      video.pause();\n      this.psv.container.removeChild(video);\n    }\n    textureData.texture?.dispose();\n  }\n\n  /**\n   * @summary Removes the current video element\n   * @private\n   */\n  __removeVideo() {\n    if (this.video) {\n      this.video.pause();\n      this.psv.container.removeChild(this.video);\n      delete this.video;\n    }\n  }\n\n  /**\n   * @summary Creates a new video element\n   * @memberOf PSV.adapters\n   * @param {string} src\n   * @return {HTMLVideoElement}\n   * @private\n   */\n  __createVideo(src) {\n    const video = document.createElement('video');\n    video.crossOrigin = this.psv.config.withCredentials ? 'use-credentials' : 'anonymous';\n    video.loop = true;\n    video.style.display = 'none';\n    video.muted = this.config.muted;\n    video.src = src;\n    video.preload = 'metadata';\n\n    this.psv.container.appendChild(video);\n\n    return video;\n  }\n\n  /**\n   * @private\n   */\n  __videoLoadPromise(video) {\n    const self = this;\n\n    return new Promise((resolve, reject) => {\n      video.addEventListener('loadedmetadata', function onLoaded() {\n        if (this.video && video.duration === this.video.duration) {\n          resolve(self.__videoBufferPromise(video, this.video.currentTime));\n        }\n        else {\n          resolve();\n        }\n        video.removeEventListener('loadedmetadata', onLoaded);\n      });\n\n      video.addEventListener('error', function onError(err) {\n        reject(err);\n        video.removeEventListener('error', onError);\n      });\n    });\n  }\n\n  /**\n   * @private\n   */\n  __videoBufferPromise(video, currentTime) {\n    return new Promise((resolve) => {\n      function onBuffer() {\n        const buffer = video.buffered;\n        for (let i = 0, l = buffer.length; i < l; i++) {\n          if (buffer.start(i) <= video.currentTime && buffer.end(i) >= video.currentTime) {\n            video.pause();\n            video.removeEventListener('buffer', onBuffer);\n            video.removeEventListener('progress', onBuffer);\n            resolve();\n            break;\n          }\n        }\n      }\n\n      // try to reduce the switching time by preloading in advance\n      // FIXME find a better way ?\n      video.currentTime = Math.min(currentTime + 2000, video.duration.currentTime);\n      video.muted = true;\n\n      video.addEventListener('buffer', onBuffer);\n      video.addEventListener('progress', onBuffer);\n\n      video.play();\n    });\n  }\n\n}\n","import * as THREE from 'three';\nimport { CONSTANTS } from '../..';\nimport { AbstractVideoAdapter } from '../shared/AbstractVideoAdapter';\n\n/**\n * @typedef {Object} PSV.adapters.CubemapVideoAdapter.Video\n * @summary Object defining a video\n * @property {string} source\n */\n\n/**\n * @typedef {Object} PSV.adapters.CubemapVideoAdapter.Options\n * @property {boolean} [autoplay=false] - automatically start the video\n * @property {boolean} [muted=autoplay] - initially mute the video\n * @property {number} [equiangular=true] - if the video is an equiangular cubemap (EAC)\n */\n\n\n/**\n * @summary Adapter for cubemap videos\n * @memberof PSV.adapters\n * @extends PSV.adapters.AbstractAdapter\n */\nexport class CubemapVideoAdapter extends AbstractVideoAdapter {\n\n  static id = 'cubemap-video';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.adapters.CubemapVideoAdapter.Options} options\n   */\n  constructor(psv, options) {\n    super(psv, {\n      equiangular: true,\n      ...options,\n    });\n  }\n\n  /**\n   * @override\n   * @param {PSV.adapters.CubemapVideoAdapter.Video} panorama\n   * @returns {Promise.<PSV.TextureData>}\n   */\n  loadTexture(panorama) {\n    return super.loadTexture(panorama);\n  }\n\n  /**\n   * @override\n   */\n  createMesh(scale = 1) {\n    const cubeSize = CONSTANTS.SPHERE_RADIUS * 2 * scale;\n    const geometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize)\n      .scale(1, 1, -1)\n      .toNonIndexed();\n\n    geometry.clearGroups();\n\n    const uvs = geometry.getAttribute('uv');\n\n    /*\n      Structure of a frame\n\n      1 +---------+---------+---------+\n        |         |         |         |\n        |  Left   |  Front  |  Right  |\n        |         |         |         |\n    1/2 +---------+---------+---------+\n        |         |         |         |\n        | Bottom  |  Back   |   Top   |\n        |         |         |         |\n      0 +---------+---------+---------+\n        0        1/3       2/3        1\n\n       Bottom, Back and Top are rotated 90Â° clockwise\n     */\n\n    // columns\n    const a = 0;\n    const b = 1 / 3;\n    const c = 2 / 3;\n    const d = 1;\n\n    // lines\n    const A = 1;\n    const B = 1 / 2;\n    const C = 0;\n\n    // left\n    uvs.setXY(0, a, A);\n    uvs.setXY(1, a, B);\n    uvs.setXY(2, b, A);\n    uvs.setXY(3, a, B);\n    uvs.setXY(4, b, B);\n    uvs.setXY(5, b, A);\n\n    // right\n    uvs.setXY(6, c, A);\n    uvs.setXY(7, c, B);\n    uvs.setXY(8, d, A);\n    uvs.setXY(9, c, B);\n    uvs.setXY(10, d, B);\n    uvs.setXY(11, d, A);\n\n    // top\n    uvs.setXY(12, d, B);\n    uvs.setXY(13, c, B);\n    uvs.setXY(14, d, C);\n    uvs.setXY(15, c, B);\n    uvs.setXY(16, c, C);\n    uvs.setXY(17, d, C);\n\n    // bottom\n    uvs.setXY(18, b, B);\n    uvs.setXY(19, a, B);\n    uvs.setXY(20, b, C);\n    uvs.setXY(21, a, B);\n    uvs.setXY(22, a, C);\n    uvs.setXY(23, b, C);\n\n    // back\n    uvs.setXY(24, c, B);\n    uvs.setXY(25, b, B);\n    uvs.setXY(26, c, C);\n    uvs.setXY(27, b, B);\n    uvs.setXY(28, b, C);\n    uvs.setXY(29, c, C);\n\n    // front\n    uvs.setXY(30, b, A);\n    uvs.setXY(31, b, B);\n    uvs.setXY(32, c, A);\n    uvs.setXY(33, b, B);\n    uvs.setXY(34, c, B);\n    uvs.setXY(35, c, A);\n\n    // shamelessly copied from https://github.com/videojs/videojs-vr\n    const material = new THREE.ShaderMaterial({\n      uniforms      : {\n        mapped     : { value: null },\n        contCorrect: { value: 1 },\n        faceWH     : { value: new THREE.Vector2(1 / 3, 1 / 2) },\n        vidWH      : { value: new THREE.Vector2(1, 1) },\n      },\n      vertexShader  : `\nvarying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);\n}`,\n      fragmentShader: `\nvarying vec2 vUv;\nuniform sampler2D mapped;\nuniform vec2 faceWH;\nuniform vec2 vidWH;\nuniform float contCorrect;\nconst float PI = 3.1415926535897932384626433832795;\nvoid main() {\n  vec2 corner = vUv - mod(vUv, faceWH) + vec2(0, contCorrect / vidWH.y);\n  vec2 faceWHadj = faceWH - vec2(0, contCorrect * 2. / vidWH.y);\n  vec2 p = (vUv - corner) / faceWHadj - .5;\n  vec2 q = ${this.config.equiangular ? '2. / PI * atan(2. * p) + .5' : 'p + .5'};\n  vec2 eUv = corner + q * faceWHadj;\n  gl_FragColor = texture2D(mapped, eUv);\n}`,\n    });\n\n    return new THREE.Mesh(geometry, material);\n  }\n\n  /**\n   * @override\n   */\n  setTexture(mesh, textureData) {\n    const { texture } = textureData;\n\n    mesh.material.uniforms.mapped.value?.dispose();\n    mesh.material.uniforms.mapped.value = texture;\n    mesh.material.uniforms.vidWH.value.set(texture.image.videoWidth, texture.image.videoHeight);\n\n    this.__switchVideo(textureData.texture);\n  }\n\n}\n"],"names":["AbstractVideoAdapter","psv","options","config","autoplay","muted","video","on","CONSTANTS","EVENTS","BEFORE_RENDER","destroy","off","__removeVideo","handleEvent","e","type","needsUpdate","loadTexture","panorama","source","Promise","reject","PSVError","getPlugin","__createVideo","__videoLoadPromise","then","texture","THREE","VideoTexture","__switchVideo","currentTime","duration","paused","volume","image","play","disposeTexture","textureData","pause","container","removeChild","dispose","src","document","createElement","crossOrigin","withCredentials","loop","style","display","preload","appendChild","self","resolve","addEventListener","onLoaded","__videoBufferPromise","removeEventListener","onError","err","onBuffer","buffer","buffered","i","l","length","start","end","Math","min","AbstractAdapter","supportsTransition","supportsPreload","supportsDownload","CubemapVideoAdapter","equiangular","createMesh","scale","cubeSize","SPHERE_RADIUS","geometry","BoxGeometry","toNonIndexed","clearGroups","uvs","getAttribute","a","b","c","d","A","B","C","setXY","material","ShaderMaterial","uniforms","mapped","value","contCorrect","faceWH","Vector2","vidWH","vertexShader","fragmentShader","Mesh","setTexture","mesh","set","videoWidth","videoHeight","id"],"mappings":"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"}